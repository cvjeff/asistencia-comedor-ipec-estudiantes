<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ingreso de Estudiantes - IPEC Barva</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body {
      font-family:'Inter',Arial,sans-serif;
      background:#f4f6fb;
      color:#1d2740;
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      justify-content: flex-start;
      align-items: center;
    }
    header {
      padding: 32px 0 12px 0;
      text-align: center;
      background: #fff;
      border-bottom: 1px solid #e6e8ee;
      margin-bottom: 15px;
      width: 100vw;
      max-width: 100%;
    }
    header img {
      max-width: 135px;
      display: block;
      margin: 0 auto 9px auto;
      border-radius: 10px;
    }
    header h1 {
      font-size: 2em;
      margin: 0;
      font-weight: 600;
      letter-spacing: 1px;
    }
    header h2 {
      font-size: 1.1em;
      margin: 10px 0 0 0;
      font-weight: 400;
      color: #4674A9;
      letter-spacing: 0.5px;
    }
    .main-content {
      flex: 1 0 auto;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .login-container, .qr-container, .cambio-container {
      background:#fff;
      border-radius:11px;
      box-shadow:0 2px 15px #1b243420;
      padding:32px 26px 20px 26px;
      max-width:380px;
      width:100%;
      text-align:center;
      margin: 25px 0 30px 0;
    }
    h2 { font-weight:600; color:#335188; }
    input[type="text"], input[type="password"] {
      width:100%;
      padding:10px 8px;
      margin:10px 0 10px 0;
      border-radius:5px;
      border:1px solid #b7c4da;
      font-size:1em;
    }
    input:focus { border: 1.5px solid #3e6bc9;}
    button {
      background:#375c91;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:9px 0;
      width:100%;
      font-weight:600;
      font-size:1.06em;
      margin:15px 0 6px 0;
    }
    #msg, #msgCambio {
      min-height:30px;
      color:#e03e3e;
      margin-bottom:7px;
    }
    #bienvenida {
      color:#18863d;
      font-weight:600;
      font-size:1.18em;
      margin-bottom:8px;
    }
    #qrCanvas {
      margin: 24px auto 12px auto;
      background:#fff;
      padding:10px;
      border-radius:10px;
      display:block;
    }
    #datosEstudianteQR {
      margin:14px 0 5px 0;
      font-size:1.12em;
      color:#24436a;
      font-weight:500;
    }
    #cambiarPass {
      background:#e1e7f6;
      color:#28447c;
      font-size:0.97em;
      margin:6px auto 0 auto;
      border:1px solid #bfd5f2;
      width:80%;
    }
    .volver-login {
      color:#2341b0;
      cursor:pointer;
      font-size:0.98em;
      margin-top:10px;
      display:inline-block;
    }
    .volver-login:hover { text-decoration:underline;}
    footer {
      text-align: center;
      font-size: 0.97em;
      color: #8190a8;
      background: #f7fafd;
      padding: 24px 2vw 14px 2vw;
      letter-spacing: 0.18px;
      border-top: 1px solid #e6e8ee;
      flex-shrink: 0;
      width: 100vw;
      max-width: 100%;
    }
    @media (max-width: 500px) {
      header { padding: 18px 0 8px 0; }
      .login-container, .qr-container, .cambio-container {
        padding:18px 2vw 13px 2vw; margin: 9px 0 15px 0;
      }
      #qrCanvas { width: 98vw !important; max-width: 300px; }
    }
  </style>
</head>
<body>
  <header>
    <img src="Logo PNG.png" alt="IPEC Barva" />
    <h1>Control de Asistencia</h1>
    <h2>Comedor estudiantil IPEC Barva</h2>
  </header>
  <div class="main-content">
    <div class="login-container" id="loginView">
      <h2>Ingreso de Estudiantes</h2>
      <form id="loginForm">
        <input type="text" id="cedula" placeholder="Cédula" required autocomplete="username">
        <input type="password" id="password" placeholder="Contraseña" required autocomplete="current-password">
        <button type="submit">Ingresar</button>
      </form>
      <div id="msg"></div>
      <button id="cambiarPass">¿Desea cambiar la contraseña?</button>
    </div>
    <div class="cambio-container" id="cambioView" style="display:none;">
      <h2>Cambiar Contraseña</h2>
      <form id="cambioForm">
        <input type="text" id="cambioCedula" placeholder="Cédula" required autocomplete="username">
        <input type="password" id="oldPass" placeholder="Contraseña actual" required>
        <input type="password" id="newPass1" placeholder="Nueva contraseña" required>
        <input type="password" id="newPass2" placeholder="Repetir nueva contraseña" required>
        <button type="submit">Actualizar Contraseña</button>
      </form>
      <div id="msgCambio"></div>
      <div class="volver-login" onclick="mostrarLogin()">← Volver al inicio</div>
    </div>
    <div class="qr-container" id="qrView" style="display:none;">
      <div id="bienvenida"></div>
      <canvas id="qrCanvas" width="320" height="320"></canvas>
      <div id="datosEstudianteQR"></div>
      <div style="margin:10px 0 5px 0; color:#4d6788;">Presente este código en el control de asistencia.</div>
      <div class="volver-login" onclick="mostrarLogin()">← Salir</div>
    </div>
  </div>
  <footer>
    Todos los derechos reservados: Ing. Jeffry Carballo Vargas, Mag.
  </footer>
  <script>
    // Supabase config
    const supabaseUrl = 'https://pqwpieuxyudsvetytoac.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxd3BpZXV4eXVkc3ZldHl0b2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwNTQ5MjksImV4cCI6MjA2NjYzMDkyOX0.FZOSbJTSiedP1yrwgXn_GLLeELxfzQ13fnIss7aDaJ4';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const loginView = document.getElementById("loginView");
    const qrView = document.getElementById("qrView");
    const cambioView = document.getElementById("cambioView");

    let estudianteActual = null;
    let cedulaActual = "";

    // Mostrar sólo login
    function mostrarLogin() {
      loginView.style.display = '';
      qrView.style.display = 'none';
      cambioView.style.display = 'none';
      document.getElementById('msg').textContent = '';
      document.getElementById('msgCambio').textContent = '';
      document.getElementById('loginForm').reset();
      estudianteActual = null;
      cedulaActual = "";
    }

    // LOGIN
    document.getElementById("loginForm").onsubmit = async function(e){
      e.preventDefault();
      document.getElementById('msg').textContent = '';
      document.getElementById('bienvenida').textContent = '';
      let cedula = document.getElementById('cedula').value.trim();
      let password = document.getElementById('password').value.trim();
      if(!cedula || !password) return;
      // Busca credencial
      const { data: login, error } = await supabaseClient
        .from('estudiante_login')
        .select('cedula')
        .eq('cedula', cedula)
        .eq('password', password)
        .maybeSingle();

      if (error || !login) {
        document.getElementById('msg').textContent = "Cédula o contraseña incorrecta.";
        return;
      }
      // Busca nombre para bienvenida
      const { data: estudiante } = await supabaseClient
        .from('estudiantes')
        .select('nombre_completo')
        .eq('cedula', cedula)
        .maybeSingle();

      estudianteActual = estudiante;
      cedulaActual = cedula;
      mostrarQR();
    }

    // MOSTRAR QR
    function mostrarQR(){
      loginView.style.display = 'none';
      cambioView.style.display = 'none';
      qrView.style.display = '';
      let nombre = estudianteActual && estudianteActual.nombre_completo ? estudianteActual.nombre_completo : cedulaActual;
      document.getElementById('bienvenida').textContent = "¡Bienvenido, " + nombre + "!";
      // QR
      const canvas = document.getElementById("qrCanvas");
      QRCode.toCanvas(canvas, cedulaActual, { width: 310 }, function (error) {
        if (error) {
          canvas.getContext("2d").clearRect(0, 0, 320, 320);
          canvas.getContext("2d").fillText("Error generando QR", 20, 150);
        }
      });
      // Mostrar datos debajo del QR
      document.getElementById('datosEstudianteQR').innerHTML = `
        <div>${nombre}</div>
        <div style="font-size:.95em; color:#375c91; font-weight:400;">Cédula: ${cedulaActual}</div>
      `;
    }

    // CAMBIO CONTRASEÑA
    document.getElementById("cambiarPass").onclick = function() {
      loginView.style.display = 'none';
      qrView.style.display = 'none';
      cambioView.style.display = '';
      document.getElementById('msgCambio').textContent = '';
      document.getElementById('cambioForm').reset();
    }
    document.getElementById("cambioForm").onsubmit = async function(e){
      e.preventDefault();
      const cedula = document.getElementById('cambioCedula').value.trim();
      const oldPass = document.getElementById('oldPass').value.trim();
      const newPass1 = document.getElementById('newPass1').value.trim();
      const newPass2 = document.getElementById('newPass2').value.trim();
      if(!cedula || !oldPass || !newPass1 || !newPass2){
        document.getElementById('msgCambio').textContent = "Complete todos los campos.";
        return;
      }
      if(newPass1 !== newPass2){
        document.getElementById('msgCambio').textContent = "La nueva contraseña no coincide.";
        return;
      }
      // Verifica actual
      const { data: login } = await supabaseClient
        .from('estudiante_login')
        .select('cedula')
        .eq('cedula', cedula)
        .eq('password', oldPass)
        .maybeSingle();
      if(!login){
        document.getElementById('msgCambio').textContent = "Cédula o contraseña actual incorrecta.";
        return;
      }
      // Cambia
      const { error } = await supabaseClient
        .from('estudiante_login')
        .update({ password: newPass1 })
        .eq('cedula', cedula);
      if(error){
        document.getElementById('msgCambio').textContent = "Error actualizando contraseña.";
        return;
      }
      document.getElementById('msgCambio').style.color = "#16863d";
      document.getElementById('msgCambio').textContent = "Contraseña actualizada exitosamente.";
      setTimeout(mostrarLogin, 1600);
    }

    // Vuelve al login desde cambio/QR
    window.mostrarLogin = mostrarLogin;
  </script>
</body>
</html>

