<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ingreso de Estudiantes - IPEC Barva</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#375c91">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    html, body {
      height: 100%;
      width: 100vw;
      padding: 0;
      margin: 0;
      box-sizing: border-box;
      background: #f4f6fb;
    }
    body {
      font-family: 'Inter', Arial, sans-serif;
      color: #1d2740;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    header {
      padding: 22px 0 10px 0;
      text-align: center;
      background: #fff;
      border-bottom: 1px solid #e6e8ee;
      margin-bottom: 12px;
      width: 100vw;
      max-width: 100vw;
      z-index: 100;
    }
    header img {
      max-width: 100px;
      width: 33vw;
      min-width: 56px;
      display: block;
      margin: 0 auto 7px auto;
      border-radius: 10px;
    }
    header h1 {
      font-size: 1.5em;
      margin: 0;
      font-weight: 600;
      letter-spacing: 0.7px;
    }
    header h2 {
      font-size: 1em;
      margin: 7px 0 0 0;
      font-weight: 400;
      color: #4674A9;
      letter-spacing: 0.3px;
    }
    .main-content {
      flex: 1 0 auto;
      width: 100vw;
      max-width: 100vw;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    .login-container, .qr-container, .cambio-container {
      background: #fff;
      border-radius: 11px;
      box-shadow: 0 2px 15px #1b243420;
      padding: 20px 5vw 20px 5vw;
      max-width: 430px;
      width: 100%;
      box-sizing: border-box;
      text-align: center;
      margin: 22px auto 20px auto;
    }
    h2 {
      font-weight: 600;
      color: #335188;
      font-size: 1.15em;
      margin: 2px 0 18px 0;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 13px 8px;
      margin: 10px 0 10px 0;
      border-radius: 6px;
      border: 1.2px solid #b7c4da;
      font-size: 1.09em;
      background: #f8fafc;
      transition: border 0.18s;
      text-align: center;
      display: block;
    }
    input:focus {
      border: 1.6px solid #3e6bc9;
      outline: none;
      background: #f0f5ff;
    }
    button {
      background: #375c91;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 13px 0;
      width: 100%;
      font-weight: 600;
      font-size: 1.12em;
      margin: 15px 0 6px 0;
      box-shadow: 0 1px 6px #25509513;
      cursor: pointer;
      transition: background .17s;
    }
    button:active, button:focus {
      background: #28447c;
      outline: none;
    }
    #msg, #msgCambio {
      min-height: 32px;
      color: #e03e3e;
      margin-bottom: 8px;
      font-size: 1em;
    }
    #bienvenida {
      color: #18863d;
      font-weight: 600;
      font-size: 1.08em;
      margin-bottom: 7px;
      margin-top: 6px;
    }
    #qrCanvas {
      margin: 18px auto 10px auto;
      background: #fff;
      padding: 8px;
      border-radius: 11px;
      display: block;
      width: 76vw !important;
      max-width: 320px;
      min-width: 128px;
      height: auto;
      box-shadow: 0 2px 10px #2351870c;
    }
    #datosEstudianteQR {
      margin: 10px 0 6px 0;
      font-size: 1.08em;
      color: #24436a;
      font-weight: 500;
      line-height: 1.24;
    }
    #cambiarPass {
      background: #e1e7f6;
      color: #28447c;
      font-size: 1em;
      margin: 7px auto 0 auto;
      border: 1px solid #bfd5f2;
      width: 85%;
    }
    .volver-login {
      color: #2341b0;
      cursor: pointer;
      font-size: 1.01em;
      margin-top: 12px;
      display: inline-block;
      font-weight: 500;
    }
    .volver-login:hover {
      text-decoration: underline;
      color: #153089;
    }
    #msgReserva {
      margin: 8px 0 7px 0;
      font-size: 1.02em;
      min-height: 18px;
      font-weight: 500;
    }
    #btnReservarTiquete {
      background: #4674A9;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      margin: 10px 0 0 0;
      width: 100%;
      font-size: 1.08em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1px 7px #2341b013;
      transition: background .17s;
    }
    #btnReservarTiquete:active, #btnReservarTiquete:focus {
      background: #183357;
      outline: none;
    }
    .info-rango {
      font-size: 0.95em;
      color: #2341b0;
      margin: 3px 0 0 0;
      font-weight: 400;
    }
    footer {
      text-align: center;
      font-size: 0.98em;
      color: #8190a8;
      background: #f7fafd;
      padding: 19px 2vw 13px 2vw;
      letter-spacing: 0.14px;
      border-top: 1px solid #e6e8ee;
      flex-shrink: 0;
      width: 100vw;
      max-width: 100vw;
      margin-top: auto;
      line-height: 1.4;
    }
    @media (max-width: 500px) {
      .login-container, .qr-container, .cambio-container {
        padding: 12px 2vw 13px 2vw;
      }
      #qrCanvas { width: 93vw !important; max-width: 96vw; }
      h2 { font-size: 1.01em; }
      #bienvenida { font-size: 0.99em; }
      #datosEstudianteQR { font-size: 0.97em; }
      input[type="text"], input[type="password"] {
        width: 92%;
        margin: 10px auto;
        padding: 8px 6px;
        font-size: 0.99em;
        border-radius: 4px;
        text-align: center;
        display: block;
      }
      button, #cambiarPass {
        font-size: 0.97em;
        padding: 10px 0;
        border-radius: 4.5px;
      }
    }
    @media (max-width: 370px) {
      .login-container, .qr-container, .cambio-container { padding: 5px 2vw; }
      input[type="text"], input[type="password"] { width: 97%; }
    }
    /* PWA popup style */
    #pwaPrompt {
      display: none;
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 9999;
      background: #fff;
      border-top: 1px solid #e4e9f2;
      box-shadow: 0 -2px 12px #1b243435;
      padding: 19px 10vw 18px 10vw;
      text-align: center;
      animation: fadein-pwa .55s;
    }
    #pwaPrompt b { color: #193f83; }
    #pwaPrompt button {
      margin: 13px auto 0 auto;
      background: #e7ebf8;
      color: #2343a1;
      border-radius: 7px;
      border: none;
      padding: 7px 18px;
      font-size: 1.01em;
      cursor: pointer;
      box-shadow: 0 2px 10px #1a4b8911;
      transition: background .19s;
    }
    #pwaPrompt button:active { background: #d3daf2; }
    @keyframes fadein-pwa { from { opacity: 0; transform: translateY(60px);} to { opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <header>
    <img src="Logo PNG.png" alt="IPEC Barva" />
    <h1>Control de Asistencia</h1>
    <h2>Comedor estudiantil IPEC Barva</h2>
  </header>
  <div class="main-content">
    <div class="login-container" id="loginView">
      <h2>Ingreso de Estudiantes</h2>
      <form id="loginForm">
        <input type="text" id="cedula" placeholder="Cédula" required autocomplete="username">
        <input type="password" id="password" placeholder="Contraseña" required autocomplete="current-password">
        <button type="submit">Ingresar</button>
      </form>
      <div id="msg"></div>
      <button id="cambiarPass">¿Desea cambiar la contraseña?</button>
    </div>
    <div class="cambio-container" id="cambioView" style="display:none;">
      <h2>Cambiar Contraseña</h2>
      <form id="cambioForm">
        <input type="text" id="cambioCedula" placeholder="Cédula" required autocomplete="username">
        <input type="password" id="oldPass" placeholder="Contraseña actual" required>
        <input type="password" id="newPass1" placeholder="Nueva contraseña" required>
        <input type="password" id="newPass2" placeholder="Repetir nueva contraseña" required>
        <button type="submit">Actualizar Contraseña</button>
      </form>
      <div id="msgCambio"></div>
      <div class="volver-login" onclick="mostrarLogin()">← Volver al inicio</div>
    </div>
    <div class="qr-container" id="qrView" style="display:none;">
      <div id="bienvenida"></div>
      <canvas id="qrCanvas" width="320" height="320"></canvas>
      <div id="datosEstudianteQR"></div>
      <div id="msgReserva"></div>
      <div id="divReserva"></div>
      <div style="margin:10px 0 5px 0; color:#4d6788;">Presente este código en el control de asistencia.</div>
      <div class="volver-login" onclick="mostrarLogin()">← Salir</div>
    </div>
  </div>
  <div id="pwaPrompt">
    <div style="font-size:1.04em; color:#214889;">
      <b>¿Desea instalar esta app en su celular?</b><br>
      <span style="font-size:0.98em; color:#4977be;">Toque <b>⋮</b> en su navegador y seleccione<br><b>“Agregar a pantalla de inicio”</b>.<br>Así podrá usarla como una app nativa.</span>
    </div>
    <button id="ocultarPwaPrompt">No volver a mostrar</button>
  </div>
  <footer>
    Todos los derechos reservados: Ing. Jeffry Carballo Vargas, Mag.
  </footer>
  <script>
    // --- CONFIGURACIÓN SUPABASE ---
    const supabaseUrl = 'https://pqwpieuxyudsvetytoac.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxd3BpZXV4eXVkc3ZldHl0b2FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwNTQ5MjksImV4cCI6MjA2NjYzMDkyOX0.FZOSbJTSiedP1yrwgXn_GLLeELxfzQ13fnIss7aDaJ4';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const loginView = document.getElementById("loginView");
    const qrView = document.getElementById("qrView");
    const cambioView = document.getElementById("cambioView");

    let estudianteActual = null;
    let cedulaActual = "";

    // Función para obtener fecha local en formato YYYY-MM-DD sin desfase UTC
    function getFechaLocalISO() {
      const d = new Date();
      d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
      return d.toISOString().slice(0, 10);
    }

    function mostrarLogin() {
      loginView.style.display = '';
      qrView.style.display = 'none';
      cambioView.style.display = 'none';
      document.getElementById('msg').textContent = '';
      document.getElementById('msgCambio').textContent = '';
      document.getElementById('loginForm').reset();
      estudianteActual = null;
      cedulaActual = "";
    }

    document.getElementById("loginForm").onsubmit = async function(e){
      e.preventDefault();
      document.getElementById('msg').textContent = '';
      document.getElementById('bienvenida').textContent = '';
      let cedula = document.getElementById('cedula').value.trim();
      let password = document.getElementById('password').value.trim();
      if(!cedula || !password) return;
      const { data: login, error } = await supabaseClient
        .from('estudiante_login')
        .select('cedula')
        .eq('cedula', cedula)
        .eq('password', password)
        .maybeSingle();

      if (error || !login) {
        document.getElementById('msg').textContent = "Cédula o contraseña incorrecta.";
        return;
      }
      const { data: estudiante } = await supabaseClient
        .from('estudiantes')
        .select('*')
        .eq('cedula', cedula)
        .maybeSingle();

      estudianteActual = estudiante;
      cedulaActual = cedula;
      mostrarQR();
    }

    function mostrarQR(){
      loginView.style.display = 'none';
      cambioView.style.display = 'none';
      qrView.style.display = '';
      let nombre = estudianteActual && estudianteActual.nombre_completo ? estudianteActual.nombre_completo : cedulaActual;
      let area = estudianteActual && estudianteActual.area_academica ? estudianteActual.area_academica : "";
      let turno = estudianteActual && estudianteActual.turno ? estudianteActual.turno : "";
      document.getElementById('bienvenida').textContent = "¡Bienvenido, " + nombre + "!";
      const canvas = document.getElementById("qrCanvas");
      QRCode.toCanvas(canvas, cedulaActual, { width: Math.min(window.innerWidth*0.88, 310) }, function (error) {
        if (error) {
          canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
          canvas.getContext("2d").fillText("Error generando QR", 20, 150);
        }
      });
      document.getElementById('datosEstudianteQR').innerHTML = `
        <div>${nombre}</div>
        <div style="font-size:.95em; color:#375c91; font-weight:400;">Cédula: ${cedulaActual}</div>
        <div style="font-size:.95em; color:#375c91;">${area ? "Área: " + area : ""}${turno ? " - Turno: " + turno : ""}</div>
      `;
      mostrarReserva();
    }

    // --- LÓGICA DE RESERVA DE TIQUETE ---
    async function mostrarReserva() {
      const divReserva = document.getElementById('divReserva');
      const msgReserva = document.getElementById('msgReserva');
      divReserva.innerHTML = '';
      msgReserva.textContent = '';
      if (!estudianteActual || !estudianteActual.turno) return;

      let ahora = new Date();
      let hora = ahora.getHours();
      let min = ahora.getMinutes();
      let puede = false, rango = "";
      let turnoLimpio = (estudianteActual.turno || "").toLowerCase().trim();
      if (turnoLimpio === "día" || turnoLimpio === "dia") {
        puede = (hora >= 8 && (hora < 10 || (hora === 10 && min === 0)));
        rango = "8:00 am a 10:00 am";
      } else if (turnoLimpio === "noche") {
        puede = (hora >= 17 && hora < 18); // Ajuste para 5 pm a 6 pm
        rango = "5:00 pm a 6:00 pm";
      } else {
        msgReserva.textContent = "Turno no permitido para reservar tiquete.";
        msgReserva.style.color = "#e03e3e";
        return;
      }

      let hoy = getFechaLocalISO();
      const { data: reserva } = await supabaseClient
        .from('reservas_tiquete')
        .select('*')
        .eq('cedula', cedulaActual)
        .eq('fecha', hoy)
        .maybeSingle();

      if (reserva) {
        msgReserva.textContent = "Ya ha reservado su tiquete para hoy.";
        msgReserva.style.color = "#18863d";
        return;
      }
      if (!puede) {
        msgReserva.innerHTML = "Solo puede reservar un tiquete en el horario permitido para su turno.";
        msgReserva.style.color = "#b78c08";
        divReserva.innerHTML = `<div class="info-rango">Horario para reservar: <b>${rango}</b></div>`;
        return;
      }

      divReserva.innerHTML = `<button id="btnReservarTiquete">Reservar tiquete de comida</button><div class="info-rango">Horario: <b>${rango}</b></div>`;
      document.getElementById('btnReservarTiquete').onclick = async function() {
        msgReserva.textContent = '';
        const { data: reserva2 } = await supabaseClient
          .from('reservas_tiquete')
          .select('*')
          .eq('cedula', cedulaActual)
          .eq('fecha', hoy)
          .maybeSingle();
        if (reserva2) {
          msgReserva.textContent = "Ya reservó su tiquete para hoy.";
          msgReserva.style.color = "#18863d";
          divReserva.innerHTML = "";
          return;
        }
        let horaReserva = ahora.toTimeString().slice(0,8);
        let { error } = await supabaseClient.from('reservas_tiquete').insert({
          cedula: cedulaActual,
          nombre_completo: estudianteActual.nombre_completo || '',
          area_academica: estudianteActual.area_academica || '',
          turno: estudianteActual.turno || '',
          fecha: hoy,
          hora_reserva: horaReserva
        });
        if (error) {
          msgReserva.textContent = "Error al reservar. Intente de nuevo.";
          msgReserva.style.color = "#e03e3e";
        } else {
          msgReserva.textContent = "¡Reserva registrada! Presente su tiquete en el comedor.";
          msgReserva.style.color = "#18863d";
          divReserva.innerHTML = "";
        }
      };
    }

    document.getElementById("cambiarPass").onclick = function() {
      loginView.style.display = 'none';
      qrView.style.display = 'none';
      cambioView.style.display = '';
      document.getElementById('msgCambio').textContent = '';
      document.getElementById('cambioForm').reset();
    }
    document.getElementById("cambioForm").onsubmit = async function(e){
      e.preventDefault();
      const cedula = document.getElementById('cambioCedula').value.trim();
      const oldPass = document.getElementById('oldPass').value.trim();
      const newPass1 = document.getElementById('newPass1').value.trim();
      const newPass2 = document.getElementById('newPass2').value.trim();
      if(!cedula || !oldPass || !newPass1 || !newPass2){
        document.getElementById('msgCambio').textContent = "Complete todos los campos.";
        return;
      }
      if(newPass1 !== newPass2){
        document.getElementById('msgCambio').textContent = "La nueva contraseña no coincide.";
        return;
      }
      const { data: login } = await supabaseClient
        .from('estudiante_login')
        .select('cedula')
        .eq('cedula', cedula)
        .eq('password', oldPass)
        .maybeSingle();
      if(!login){
        document.getElementById('msgCambio').textContent = "Cédula o contraseña actual incorrecta.";
        return;
      }
      const { error } = await supabaseClient
        .from('estudiante_login')
        .update({ password: newPass1 })
        .eq('cedula', cedula);
      if(error){
        document.getElementById('msgCambio').textContent = "Error actualizando contraseña.";
        return;
      }
      document.getElementById('msgCambio').style.color = "#16863d";
      document.getElementById('msgCambio').textContent = "Contraseña actualizada exitosamente.";
      setTimeout(mostrarLogin, 1500);
    }
    window.mostrarLogin = mostrarLogin;

    // --- Popup para instalación como app ---
    function mostrarPWAPrompt() {
      if (window.matchMedia('(display-mode: standalone)').matches) return;
      if (localStorage.getItem('ocultarPWAPrompt')) return;
      document.getElementById('pwaPrompt').style.display = 'block';
    }
    document.getElementById('ocultarPwaPrompt').onclick = function() {
      document.getElementById('pwaPrompt').style.display = 'none';
      localStorage.setItem('ocultarPWAPrompt', '1');
    };
    setTimeout(mostrarPWAPrompt, 1200);
  </script>
</body>
</html>
